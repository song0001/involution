<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LRU缓存机制-链表实现方式</title>
</head>
<body>
  <script>
    // leetcode: https://leetcode-cn.com/problems/lru-cache/
    function LRUCache (max) {
      this.map = {}
      this.size = 0
      this.maxSize = max
      this.head = {
        prev: null,
        next: null
      }
      this.tail = {
        prev: this.head,
        next: null
      }
      this.head.next = this.tail
    }
    LRUCache.prototype.get = function (key) {
      if (key in this.map) {
        const node = this.extractNode(this.map[key])
        // 最近访问的节点放到链表头部
        this.insertToHead(node)
        return this.map[key].value
      } else {
        return -1
      }
    }
    LRUCache.prototype.put = function (key, value) {
      let node
      if (key in this.map) {
        node = this.extractNode(this.map[key])
        node.value = value
      } else {
        node = {
          prev: null,
          next: null,
          value: value,
          key: key
        }
        this.map[key] = node
        this.size++
      }
      // 插入到链表头部
      this.insertToHead(node)
      // 判断是否溢出
      if (this.size > this.maxSize) {
        const nodeToDelete = this.tail.prev
        this.extractNode(nodeToDelete)
        this.size--
        delete this.map[nodeToDelete.key]
      }
    }
    LRUCache.prototype.extractNode = function (node) {
      const beforeNode = node.prev
      const afterNode = node.next
      beforeNode.next = afterNode
      afterNode.prev = beforeNode
      node.prev = null
      node.next = null
      return node
    }
    LRUCache.prototype.insertToHead = function (node) {
      const head = this.head
      const lastFirstNode = head.next
      head.next = node
      node.prev = head
      node.next = lastFirstNode
      lastFirstNode.prev = node
      return node
    }

    const lruCache = new LRUCache(2);
    console.log(lruCache.put(1, 1)); // 缓存是 {1=1}
    console.log(lruCache.put(2, 2)); // 缓存是 {1=1, 2=2}
    console.log(lruCache.get(1));    // 返回 1
    console.log(lruCache.put(3, 3)); // 该操作会使得关键字 2 作废，缓存是 {1=1, 3=3}
    console.log(lruCache.get(2));    // 返回 -1 (未找到)
    console.log(lruCache.put(4, 4)); // 该操作会使得关键字 1 作废，缓存是 {4=4, 3=3}
    console.log(lruCache.get(1));    // 返回 -1 (未找到)
    console.log(lruCache.get(3));    // 返回 3
    console.log(lruCache.get(4));    // 返回 4
  </script>
</body>
</html>